{# templates/pdf/equipements.html.twig - Version corrigée #}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Équipements du client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            background-image: url('{{ imageUrl|default("https://www.pdf.somafi-group.fr/background/group.jpg") }}');
            background-size: cover;
            background-position: center;
            padding-top: 150px;
            margin: 0 !important;
        }
        
        .error-mode {
            background-color: #f8f9fa;
            border: 2px solid #dc3545;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .performance-mode {
            background-color: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-size: 11px;
        }
        
        .page-break {
            page-break-after: always;
        }
        .equipement {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .equipement-header {
            background-color: #f5f5f5;
            padding: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .photo {
            max-width: 300px;
            max-height: 200px;
            margin: 5px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 5px;
            text-align: left;
        }
        th {
            width: 30%;
            background-color: #f9f9f9;
        }
        .filter-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
        }
        .filter-badge {
            background-color: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 5px;
        }
        .stats-table {
            width: 100%;
            margin-bottom: 20px;
        }
        .no-image {
            width: 150px;
            height: 100px;
            background-color: #f8f9fa;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    {# Debug info - à supprimer en production #}
    {% if app.environment == 'dev' %}
        <div style="background: yellow; padding: 5px; font-size: 10px;">
            DEBUG: imageUrl = {{ imageUrl|default('NON DÉFINIE') }}<br>
            clientAnneeFilter = {{ clientAnneeFilter|default('NON DÉFINIE') }}<br>
            clientVisiteFilter = {{ clientVisiteFilter|default('NON DÉFINIE') }}
        </div>
    {% endif %}

    <h1>Rapport des équipements - Client {{ clientId|default('N/A') }}</h1>
    <p>Agence: {{ agence|default('N/A') }} | Généré le {{ "now"|date("d/m/Y à H:i") }}</p>
    
    {# Mode erreur #}
    {% if error_mode is defined and error_mode %}
        <div class="error-mode">
            <h2>⚠️ Génération incomplète</h2>
            <p><strong>{{ error_message|default('Une erreur est survenue lors de la génération du PDF complet.') }}</strong></p>
            
            {% if debug_info is defined and debug_info %}
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin: 10px 0;">
                    <h6>Informations de debug :</h6>
                    <ul style="margin: 0; text-align: left;">
                        {% if debug_info.filtre_annee %}
                            <li>Filtre année : {{ debug_info.filtre_annee }}</li>
                        {% endif %}
                        {% if debug_info.filtre_visite %}
                            <li>Filtre visite : {{ debug_info.filtre_visite }}</li>
                        {% endif %}
                        {% if debug_info.total_equipements_bruts is defined %}
                            <li>Équipements bruts trouvés : {{ debug_info.total_equipements_bruts }}</li>
                        {% endif %}
                    </ul>
                </div>
            {% endif %}
            
            <p><strong>Solutions :</strong></p>
            <ul style="text-align: left; display: inline-block;">
                <li>Vérifiez que les filtres correspondent aux données disponibles</li>
                <li>Utilisez les filtres par année ou par visite différents</li>
                <li>Essayez de générer le PDF sans filtres</li>
                <li>Contactez le support technique si le problème persiste</li>
            </ul>
        </div>
    {% endif %}
    
    {# Mode performance pour gros volumes #}
    {% if performance_mode is defined and performance_mode %}
        <div class="performance-mode">
            <strong>ℹ️ Mode performance activé</strong><br>
            {{ equipment_count|default(0) }} équipements détectés. 
            Les photos ont été désactivées pour optimiser la génération du PDF.
        </div>
    {% endif %}

    {# Affichage des filtres actifs #}
    {% if (clientAnneeFilter is defined and clientAnneeFilter) or (clientVisiteFilter is defined and clientVisiteFilter) %}
        <div class="filter-info">
            <strong>Filtres appliqués:</strong>
            {% if clientAnneeFilter is defined and clientAnneeFilter %}
                <span class="filter-badge">Année: {{ clientAnneeFilter }}</span>
            {% endif %}
            {% if clientVisiteFilter is defined and clientVisiteFilter %}
                <span class="filter-badge">Visite: {{ clientVisiteFilter }}</span>
            {% endif %}
        </div>
    {% endif %}

    {# Statistiques #}
    {% if statistiques is defined %}
        <div class="statistiques">
            <h3>Statistiques des équipements</h3>
            <table class="stats-table">
                <tr>
                    <th>Total équipements</th>
                    <td>{{ statistiques.total|default(0) }}</td>
                </tr>
                {% if statistiques.par_etat is defined %}
                    {% for etat, count in statistiques.par_etat %}
                        <tr>
                            <th>{{ etat }}</th>
                            <td>{{ count }}</td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </table>
        </div>
    {% endif %}

    {# Section principale des équipements #}
    {% if equipmentsWithPictures is defined and equipmentsWithPictures|length > 0 %}
        <h2>Équipements principaux ({{ equipmentsWithPictures|length }})</h2>
        
        {% for equipmentData in equipmentsWithPictures %}
            {% set equipment = equipmentData.equipment %}
            {% set pictures = equipmentData.pictures|default([]) %}
            
            <div class="equipement">
                <div class="equipement-header">
                    Équipement {{ equipment.numeroEquipement|default('N/A') }} - {{ equipment.marque|default('N/A') }}
                </div>
                
                <table>
                    <tr>
                        <th>Numéro</th>
                        <td>{{ equipment.numeroEquipement|default('N/A') }}</td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td>{{ equipment.type|default('Non renseigné') }}</td>
                    </tr>
                    <tr>
                        <th>Marque</th>
                        <td>{{ equipment.marque|default('N/A') }}</td>
                    </tr>
                    <tr>
                        <th>Modèle</th>
                        <td>{{ equipment.modele|default('Non renseigné') }}</td>
                    </tr>
                    <tr>
                        <th>État</th>
                        <td>{{ equipment.etat|default('N/A') }}</td>
                    </tr>
                    <tr>
                        <th>Mise en service</th>
                        <td>{{ equipment.anneeInstallation|default('N/A') }}</td>
                    </tr>
                    <tr>
                        <th>Repère site client</th>
                        <td>{{ equipment.repereClient|default('N/A') }}</td>
                    </tr>
                </table>

                {# Photos seulement si pas en mode performance #}
                {% if pictures|length > 0 and not (performance_mode is defined and performance_mode) %}
                    <div class="photos">
                        <h4>
                            Photo{{ pictures|length > 1 ? 's' : '' }} 
                            ({{ pictures|length }} photo{{ pictures|length > 1 ? 's' : '' }})
                        </h4>
                        <div class="photos-grid">
                            {% for pictureData in pictures %}
                                {% if pictureData.picture is defined and pictureData.picture %}
                                    <div class="photo-container">
                                        <img src="data:image/jpeg;base64,{{ pictureData.picture }}" 
                                             class="photo" 
                                             alt="Photo équipement {{ equipment.numeroEquipement|default('N/A') }}">
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% elseif performance_mode is not defined or not performance_mode %}
                    <div class="no-image">
                        <em>Aucune photo disponible</em>
                    </div>
                {% endif %}
            </div>
            
            {# Saut de page tous les 2 équipements sauf en mode performance #}
            {% if not (performance_mode is defined and performance_mode) and loop.index is divisible by(2) and not loop.last %}
                <div class="page-break"></div>
            {% endif %}
        {% endfor %}
    {% else %}
        <div class="error-mode">
            <p>Aucun équipement trouvé avec les critères sélectionnés.</p>
        </div>
    {% endif %}

    {# Section des équipements supplémentaires #}
    {% if equipementsSupplementaires is defined and equipementsSupplementaires|length > 0 %}
        <div class="page-break"></div>
        <div class="equipements-supplementaires">
            <h2>Équipements supplémentaires ({{ equipementsSupplementaires|length }})</h2>
            
            {% for equipmentData in equipementsSupplementaires %}
                {% set equipment = equipmentData.equipment %}
                {% set pictures = equipmentData.pictures|default([]) %}
                
                <div class="equipement">
                    <table class="info-table">
                        <tr>
                            <td rowspan="7" class="equipment-image">
                                {% if pictures|length > 0 and not (performance_mode is defined and performance_mode) %}
                                    <img src="data:image/jpeg;base64,{{ pictures[0].picture }}" 
                                         class="main-photo" 
                                         alt="Photo équipement {{ equipment.numeroEquipement|default('N/A') }}">
                                {% else %}
                                    <div class="no-image">
                                        <em>Photo non disponible</em>
                                    </div>
                                {% endif %}
                            </td>
                            <td style="width: 70%;">
                                <table style="width: 100%; border: none;">
                                    <tr>
                                        <th colspan="2" style="border: none; background: #f5f5f5; text-align: center; padding: 8px;">
                                            Équipement {{ equipment.numeroEquipement|default('N/A') }} - {{ equipment.marque|default('N/A') }}
                                        </th>
                                    </tr>
                                    <tr style="border: none;">
                                        <td style="border: none; padding: 4px;"><strong>Type:</strong></td>
                                        <td style="border: none; padding: 4px;">{{ equipment.type|default('Non renseigné') }}</td>
                                    </tr>
                                    <tr style="border: none;">
                                        <td style="border: none; padding: 4px;"><strong>Modèle:</strong></td>
                                        <td style="border: none; padding: 4px;">{{ equipment.modele|default('Non renseigné') }}</td>
                                    </tr>
                                    <tr style="border: none;">
                                        <td style="border: none; padding: 4px;"><strong>État:</strong></td>
                                        <td style="border: none; padding: 4px;">{{ equipment.etat|default('N/A') }}</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {# Section des équipements non présents #}
    {% if equipementsNonPresents is defined and equipementsNonPresents|length > 0 %}
        <div class="page-break"></div>
        <div class="equipements-non-presents">
            <h2>Équipements non présents ({{ equipementsNonPresents|length }})</h2>
            <table>
                <thead>
                    <tr>
                        <th>Numéro</th>
                        <th>Type</th>
                        <th>Marque</th>
                        <th>État</th>
                    </tr>
                </thead>
                <tbody>
                    {% for equipmentData in equipementsNonPresents %}
                        {% set equipment = equipmentData.equipment %}
                        <tr>
                            <td>{{ equipment.numeroEquipement|default('N/A') }}</td>
                            <td>{{ equipment.type|default('Non renseigné') }}</td>
                            <td>{{ equipment.marque|default('N/A') }}</td>
                            <td>{{ equipment.etat|default('N/A') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    {# Footer avec informations de génération #}
    <div style="margin-top: 30px; font-size: 10px; color: #666;">
        Document généré automatiquement le {{ "now"|date("d/m/Y à H:i") }} - 
        {% if equipmentsWithPictures is defined %}
            {{ equipmentsWithPictures|length }} équipements traités
        {% endif %}
        {% if performance_mode is defined and performance_mode %}
            - Mode performance
        {% endif %}
        {% if error_mode is defined and error_mode %}
            - Génération partielle
        {% endif %}
    </div>
</body>
</html>