{# templates/pdf/equipements.html.twig #}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Équipements Client {{ clientId }} - {{ agence }}</title>
    <style>
        /* Style optimisé pour réduire la charge mémoire */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .page { page-break-after: always; }
        .equipment-container { 
            margin: 10px; 
            border: 1px solid #ccc; 
            padding: 10px; 
            height: 350px; 
            display: table; 
            width: calc(50% - 20px); 
            float: left; 
        }
        
        .equipment-image { 
            width: 30%; 
            vertical-align: top; 
            text-align: center; 
        }
        
        .main-photo { 
            max-width: 150px; 
            max-height: 150px; 
            object-fit: cover; 
        }
        
        .no-image { 
            width: 150px; 
            height: 150px; 
            border: 2px dashed #ccc; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #666; 
        }
        
        .equipment-info { width: 70%; vertical-align: top; }
        .info-table { width: 100%; border-collapse: collapse; }
        .info-row td { padding: 5px; border-bottom: 1px solid #eee; }
        .info-key { font-weight: bold; width: 40%; }
        .info-value { width: 60%; }
        .anomalies-row .info-value { color: #d9534f; font-weight: bold; }
        
        .clear { clear: both; }
        .page-break { page-break-before: always; clear: both; }
        
        /* En-tête optimisé */
        .header { 
            background: url('{{ imageUrl }}') no-repeat center; 
            background-size: cover; 
            height: 100px; 
            margin-bottom: 20px; 
        }
        
        /* Message d'optimisation */
        .optimization-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            color: #856404;
        }
    </style>
</head>
<body>
    {# En-tête du document #}
    <div class="header"></div>
    
    {# Message d'optimisation si nécessaire #}
    {% if isOptimizedMode is defined and isOptimizedMode %}
        <div class="optimization-notice">
            <strong>Mode optimisé activé :</strong> 
            {{ optimizationMessage ?? 'PDF généré en mode optimisé pour éviter les erreurs mémoire.' }}
        </div>
    {% endif %}
    
    {# Informations client #}
    <div style="margin: 20px 0;">
        <h2>Client : {{ clientId }} - Agence {{ agence }}</h2>
        {% if totalEquipmentsFound is defined %}
            <p><strong>{{ maxEquipmentsProcessed ?? 0 }}</strong> équipements traités sur <strong>{{ totalEquipmentsFound }}</strong> au total.</p>
        {% endif %}
    </div>
    
    {# Liste des équipements - VERSION OPTIMISÉE #}
    {% if equipmentsWithPictures is defined and equipmentsWithPictures|length > 0 %}
        {% set equipmentCount = 0 %}
        
        {% for equipmentData in equipmentsWithPictures %}
            {% set equipment = equipmentData.equipment %}
            {% set pictures = equipmentData.pictures %}
            {% set equipmentCount = equipmentCount + 1 %}
            
            {# Nouvelle page tous les 4 équipements (2x2) #}
            {% if (equipmentCount - 1) % 4 == 0 %}
                {% if not loop.first %}<div class="page-break"></div>{% endif %}
            {% endif %}
            
            <div class="equipment-container">
                <table style="width: 100%; height: 100%;">
                    <tr>
                        <td class="equipment-image">
                            {% if pictures|length > 0 %}
                                {# OPTIMISATION : Vérifier si l'image n'est pas trop lourde #}
                                {% if pictures[0].oversized is defined and pictures[0].oversized %}
                                    <div class="no-image">
                                        <em>Image trop volumineuse<br>non affichée</em>
                                    </div>
                                {% else %}
                                    <img src="data:image/jpeg;base64,{{ pictures[0].picture }}" 
                                         class="main-photo" 
                                         alt="Photo {{ equipment.numeroEquipement }}"
                                         loading="lazy">
                                {% endif %}
                            {% else %}
                                <div class="no-image">
                                    <em>Aucune photo<br>disponible</em>
                                </div>
                            {% endif %}
                        </td>
                        <td class="equipment-info">
                            <h3 style="margin: 0 0 10px 0; color: #333;">
                                {{ equipment.numeroEquipement }} - {{ equipment.type ?? 'Type non défini' }}
                            </h3>
                            
                            <table class="info-table">
                                <tr class="info-row">
                                    <td class="info-key">Marque</td>
                                    <td class="info-value">{{ equipment.marque ?? 'Non renseignée' }}</td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-key">Modèle</td>
                                    <td class="info-value">{{ equipment.modele ?? 'Non renseigné' }}</td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-key">État</td>
                                    <td class="info-value">{{ equipment.etat ?? 'Non défini' }}</td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-key">Mise en service</td>
                                    <td class="info-value">{{ equipment.miseEnService ?? 'Non renseignée' }}</td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-key">Repère site</td>
                                    <td class="info-value">{{ equipment.repereSiteClient ?? 'Non repéré' }}</td>
                                </tr>
                                
                                {# Anomalies seulement si présentes #}
                                {% if equipment.anomalies is defined and equipment.anomalies|trim is not empty %}
                                <tr class="info-row anomalies-row">
                                    <td class="info-key">Anomalies</td>
                                    <td class="info-value">{{ equipment.anomalies }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </td>
                    </tr>
                </table>
            </div>
            
            {# Clear après chaque paire d'équipements #}
            {% if equipmentCount % 2 == 0 %}
                <div class="clear"></div>
            {% endif %}
        {% endfor %}
        
        {# Clear final #}
        <div class="clear"></div>
        
    {% else %}
        <div style="text-align: center; padding: 50px; color: #666;">
            <h3>Aucun équipement trouvé</h3>
            <p>Aucun équipement n'a été trouvé pour ce client.</p>
        </div>
    {% endif %}
    
    {# Mode erreur #}
    {% if error_mode is defined and error_mode %}
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; margin: 20px; border-radius: 5px;">
            <h3 style="color: #721c24;">Erreur durant la génération</h3>
            <p><strong>Message :</strong> {{ error_message ?? 'Erreur inconnue' }}</p>
            <p><em>Ce PDF a été généré en mode dégradé.</em></p>
        </div>
    {% endif %}
    
    {# Footer #}
    <div style="position: fixed; bottom: 20px; width: 100%; text-align: center; font-size: 12px; color: #666;">
        Document généré automatiquement le {{ "now"|date('d/m/Y à H:i') }}
        {% if equipmentsWithPictures is defined %}
            - {{ equipmentsWithPictures|length }} équipement{{ equipmentsWithPictures|length > 1 ? 's' : '' }} traité{{ equipmentsWithPictures|length > 1 ? 's' : '' }}
        {% endif %}
    </div>
</body>
</html>