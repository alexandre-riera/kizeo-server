{# templates/pdf/equipements.html.twig - VERSION CORRIGÉE URGENTE #}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Équipements Client {{ clientId }} - {{ agence }}</title>
    <style>
        /* Style minimal et sûr */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .equipment-row { 
            margin-bottom: 20px; 
            border: 1px solid #ddd; 
            padding: 15px; 
            display: block;
            width: 100%;
        }
        
        .equipment-image { 
            width: 200px; 
            height: 150px;
            float: left;
            margin-right: 15px;
            text-align: center; 
        }
        
        .main-photo { 
            max-width: 200px; 
            max-height: 150px; 
            border: 1px solid #ccc;
        }
        
        .no-image { 
            width: 200px; 
            height: 150px; 
            border: 2px dashed #ccc; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #666; 
            font-style: italic;
        }
        
        .equipment-info { margin-left: 220px; }
        .info-table { width: 100%; border-collapse: collapse; }
        .info-row td { padding: 8px; border-bottom: 1px solid #eee; }
        .info-key { font-weight: bold; width: 150px; }
        .info-value { }
        .anomalies-row .info-value { color: #d9534f; font-weight: bold; }
        
        .clear { clear: both; }
        .page-break { page-break-before: always; clear: both; }
        
        /* Message d'optimisation */
        .optimization-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            color: #856404;
        }
    </style>
</head>
<body>
    {# Message d'optimisation si nécessaire #}
    {% if isOptimizedMode is defined and isOptimizedMode %}
        <div class="optimization-notice">
            <strong>Mode optimisé activé :</strong> 
            {{ optimizationMessage ?? 'PDF généré en mode optimisé pour éviter les erreurs mémoire.' }}
        </div>
    {% endif %}
    
    {# Informations client #}
    <div style="margin: 20px 0;">
        <h2>Client : {{ clientId }} - Agence {{ agence }}</h2>
        {% if totalEquipmentsFound is defined %}
            <p><strong>{{ maxEquipmentsProcessed ?? 0 }}</strong> équipements traités sur <strong>{{ totalEquipmentsFound }}</strong> au total.</p>
        {% endif %}
    </div>
    
    {# Liste des équipements - VERSION SIMPLIFIÉE ET SÛRE #}
    {% if equipmentsWithPictures is defined and equipmentsWithPictures|length > 0 %}
        
        {% for equipmentData in equipmentsWithPictures %}
            {% set equipment = equipmentData.equipment %}
            {% set pictures = equipmentData.pictures %}
            
            {# Saut de page tous les 3 équipements #}
            {% if loop.index > 1 and (loop.index - 1) % 3 == 0 %}
                <div class="page-break"></div>
            {% endif %}
            
            <div class="equipment-row">
                {# Image de l'équipement #}
                <div class="equipment-image">
                    {% if pictures is defined and pictures|length > 0 %}
                        {% set firstPicture = pictures[0] %}
                        {% if firstPicture.picture is defined %}
                            <img src="data:image/jpeg;base64,{{ firstPicture.picture }}" 
                                 class="main-photo" 
                                 alt="Photo {{ equipment.numeroEquipement }}">
                        {% else %}
                            <div class="no-image">
                                Aucune photo<br>disponible
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="no-image">
                            Aucune photo<br>disponible
                        </div>
                    {% endif %}
                </div>
                
                {# Informations de l'équipement #}
                <div class="equipment-info">
                    <h3 style="margin: 0 0 10px 0; color: #333;">
                        Équipement {{ equipment.numeroEquipement }} - {{ equipment.type ?? 'Type non défini' }}
                    </h3>
                    
                    <table class="info-table">
                        <tr class="info-row">
                            <td class="info-key">Marque :</td>
                            <td class="info-value">{{ equipment.marque ?? 'Non renseignée' }}</td>
                        </tr>
                        <tr class="info-row">
                            <td class="info-key">Modèle :</td>
                            <td class="info-value">{{ equipment.modele ?? 'Non renseigné' }}</td>
                        </tr>
                        <tr class="info-row">
                            <td class="info-key">État :</td>
                            <td class="info-value">{{ equipment.etat ?? 'Non défini' }}</td>
                        </tr>
                        <tr class="info-row">
                            <td class="info-key">Mise en service :</td>
                            <td class="info-value">{{ equipment.miseEnService ?? 'Non renseignée' }}</td>
                        </tr>
                        <tr class="info-row">
                            <td class="info-key">Repère site :</td>
                            <td class="info-value">{{ equipment.repereSiteClient ?? 'Non repéré' }}</td>
                        </tr>
                        
                        {# Anomalies seulement si présentes #}
                        {% if equipment.anomalies is defined and equipment.anomalies|trim is not empty %}
                        <tr class="info-row anomalies-row">
                            <td class="info-key">Anomalies :</td>
                            <td class="info-value">{{ equipment.anomalies }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
                
                <div class="clear"></div>
            </div>
        {% endfor %}
        
    {% else %}
        <div style="text-align: center; padding: 50px; color: #666;">
            <h3>Aucun équipement trouvé</h3>
            <p>Aucun équipement n'a été trouvé pour ce client.</p>
        </div>
    {% endif %}
    
    {# Mode erreur #}
    {% if error_mode is defined and error_mode %}
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; margin: 20px; border-radius: 5px;">
            <h3 style="color: #721c24;">Erreur durant la génération</h3>
            <p><strong>Message :</strong> {{ error_message ?? 'Erreur inconnue' }}</p>
            <p><em>Ce PDF a été généré en mode dégradé.</em></p>
        </div>
    {% endif %}
    
    {# Footer #}
    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 10px;">
        Document généré automatiquement le {{ "now"|date('d/m/Y à H:i') }}
        {% if equipmentsWithPictures is defined %}
            - {{ equipmentsWithPictures|length }} équipement{{ equipmentsWithPictures|length > 1 ? 's' : '' }} traité{{ equipmentsWithPictures|length > 1 ? 's' : '' }}
        {% endif %}
    </div>
</body>
</html>