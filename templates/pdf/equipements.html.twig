{# templates/pdf/equipements.html.twig #}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Compte rendu d'entretien</title>
    <style>
        @page {
            margin: 0;
            padding: 0;
            size: A4;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            font-size: 12px;
            background-image: url('{{ imageUrl }}');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        .page-content {
            margin: 100px 40px 60px 40px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 5px;
        }
        
        /* PREMIÈRE PAGE */
        .first-page {
            page-break-after: always;
        }
        
        .header-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 30px;
            text-transform: uppercase;
        }
        
        .visit-info {
            margin-bottom: 20px;
        }
        
        .visit-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .client-info {
            margin-bottom: 30px;
        }
        
        .client-info h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .client-info p {
            margin: 3px 0;
            font-size: 13px;
        }
        
        .summary-section {
            margin-bottom: 30px;
        }
        
        .summary-title {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .summary-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .stat-label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 11px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }
        
        .equipment-summary {
            margin-bottom: 30px;
        }
        
        .section-title {
            background-color: #ecf0f1;
            padding: 10px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .status-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: white;
        }
        
        .status-table th {
            background-color: #f1c40f;
            color: #2c3e50;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .status-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #bdc3c7;
        }
        
        .status-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
        }
        
        .status-icon.vert {
            background-color: #27ae60;
        }
        
        .status-icon.rouge {
            background-color: #e74c3c;
        }
        
        .status-icon.orange {
            background-color: #f39c12;
        }
        
        .status-icon.noir {
            background-color: #34495e;
        }
        
        .status-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .status-icon.vert::after {
            content: '✓';
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .status-icon.rouge::after {
            content: '✗';
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .status-icon.orange::after {
            content: '!';
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .status-icon.noir::after {
            content: '●';
            color: white;
            font-weight: bold;
            font-size: 8px;
        }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        /* PAGES ÉQUIPEMENTS */
        .equipment-page {
            page-break-before: always;
        }
        
        .equipment-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .equipment-card {
            border: 2px solid #3498db;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            margin-bottom: 20px;
        }
        
        .equipment-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .equipment-status {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .equipment-title {
            flex: 1;
        }
        
        .equipment-number {
            font-size: 18px;
            font-weight: bold;
        }
        
        .equipment-type {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .equipment-body {
            display: flex;
            padding: 20px;
            gap: 20px;
        }
        
        .equipment-photo {
            flex-shrink: 0;
            width: 250px;
        }
        
        .equipment-photo img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
        }
        
        .equipment-details {
            flex: 1;
        }
        
        .details-table {
            width: 100%;
        }
        
        .details-table tr {
            border-bottom: 1px solid #ecf0f1;
        }
        
        .details-table th {
            text-align: left;
            padding: 8px 12px 8px 0;
            font-weight: bold;
            color: #2c3e50;
            width: 30%;
            font-size: 11px;
        }
        
        .details-table td {
            padding: 8px 0;
            color: #34495e;
            font-size: 11px;
        }
        
        .anomalies-row td {
            color: #e74c3c !important;
            font-weight: bold;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        .footer {
            position: fixed;
            bottom: 20px;
            left: 40px;
            right: 40px;
            text-align: center;
            font-size: 10px;
            color: #7f8c8d;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 3px;
        }
        

    </style>
</head>
<body>
    {# Définition des mappings de statuts #}
    {% set statusMapping = {
        'A': 'Bon état',
        'B': 'Travaux à prévoir', 
        'C': 'Travaux curatifs urgents',
        'D': 'Équipement inaccessible',
        'E': 'Équipement à l\'arrêt',
        'F': 'Équipement mis à l\'arrêt',
        'G': 'Équipement non présent'
    } %}
    
    {% set statusColors = {
        'A': 'vert',
        'B': 'orange', 
        'C': 'rouge',
        'D': 'noir',
        'E': 'rouge',
        'F': 'rouge',
        'G': 'noir'
    } %}
    {# PREMIÈRE PAGE - RÉSUMÉ #}
    <div class="first-page">
        <div class="page-content">
            <h1 class="header-title">Compte rendu d'entretien</h1>
            
            <div class="visit-info">
                <p><strong>Visite :</strong> {{ clientVisiteFilter }} - {{ clientAnneeFilter }}</p>
                <p><strong>Date de visite :</strong> {{ dateDeDerniererVisite|date('d/m/Y') }}</p>
            </div>
            
            <div class="client-info">
                <h3>{{nomClient}}</h3>
                <p>{{adressep1}}</p>
                <p>{{adressep1}}</p>
                <p>{{cpostalp}} {{villep}}</p>
            </div>
            
            <div class="summary-section">
                <h2 class="summary-title">Résumé</h2>
                
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-label">Nombre d'équipements au contrat</div>
                        <div class="stat-value">{{ statistiques.total ?: '0' }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Nombre d'équipements inexistants</div>
                        <div class="stat-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Nombre d'équipements supplémentaires</div>
                        {% if statistiquesSupplementaires.total is defined and statistiquesSupplementaires.total > 0 %}
                            <div class="stat-value
                            <div class="stat-value">{{ statistiquesSupplementaires.total ?: '0' }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {# ÉQUIPEMENTS AU CONTRAT #}
            {% if statistiques is defined and statistiques %}
                <div class="equipment-summary">
                    <div class="section-title">Équipements visités</div>
                    <div class="section-subtitle">(Équipements au contrat - Inexistants)</div>
                    
                    <table class="status-table">
                        <thead>
                            <tr>
                                <th>Statut</th>
                                <th>État</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if statistiques.A is defined and statistiques.A > 0 %}
                            <tr>
                                <td><span class="status-icon vert"></span></td>
                                <td>Bon état</td>
                                <td>{{ statistiques.A }}</td>
                            </tr>
                            {% endif %}
                            {% if statistiques.C is defined and statistiques.C > 0 %}
                            <tr>
                                <td><span class="status-icon rouge"></span></td>
                                <td>Travaux curatifs urgents</td>
                                <td>{{ statistiques.C }}</td>
                            </tr>
                            {% endif %}
                            {% if statistiques.E is defined and statistiques.E > 0 %}
                            <tr>
                                <td><span class="status-icon rouge"></span></td>
                                <td>Équipement à l'arrêt</td>
                                <td>{{ statistiques.E }}</td>
                            </tr>
                            {% endif %}
                            {% if statistiques.B is defined and statistiques.B > 0 %}
                            <tr>
                                <td><span class="status-icon orange"></span></td>
                                <td>Travaux à prévoir</td>
                                <td>{{ statistiques.B }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
            
            {# ÉQUIPEMENTS SUPPLÉMENTAIRES #}
            {% if statistiquesSupplementaires is defined and statistiquesSupplementaires %}
                <div class="equipment-summary">
                    <div class="section-title">Équipements supplémentaires</div>
                    
                    <table class="status-table">
                        <thead>
                            <tr>
                                <th>Statut</th>
                                <th>État</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for status, count in statistiquesSupplementaires %}
                                {% if status != 'total' and count > 0 %}
                                <tr>
                                    <td><span class="status-icon {{ statusColors[status] ?: 'noir' }}"></span></td>
                                    <td>{{ statusMapping[status] ?: status }}</td>
                                    <td>{{ count }}</td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
            
            {# LÉGENDE #}
            <div class="legend">
                <div class="legend-title">Légende :</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-icon vert status-icon"></span>
                        <span>Bon état</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon orange status-icon"></span>
                        <span>Travaux à prévoir</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon rouge status-icon"></span>
                        <span>Travaux curatifs/Arrêt</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon noir status-icon"></span>
                        <span>Inaccessible/Inexistant</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {# PAGES ÉQUIPEMENTS AU CONTRAT #}
    {% if equipmentsWithPictures is defined and equipmentsWithPictures|length > 0 %}
        {% set equipmentCount = 0 %}
        {% for equipment in equipmentsWithPictures %}
            {% dump(equipment) %}
            {% set equipmentCount = equipmentCount + 1 %}
            
            {# Nouveau page tous les 3 équipements #}
            {% if (equipmentCount - 1) % 3 == 0 %}
                {% if equipmentCount > 1 %}</div></div>{% endif %}
                <div class="equipment-page">
                    <div class="page-content">
            {% endif %}
            
            <div class="equipment-card">
                <div class="equipment-header">
                    <div class="equipment-status {{ statusColors[equipment.etat] is defined ? statusColors[equipment.etat] : 'noir' }} status-icon"></div>
                    <div class="equipment-title">
                        <div class="equipment-number">Équipement {{ equipment.numeroEquipement }} - {{ equipment.libelleEquipement ?: 'Type non renseigné' }}</div>
                        <div class="equipment-type">{{ statusMapping[equipment.etat] is defined ? statusMapping[equipment.etat] : equipment.etat }}</div>
                    </div>
                </div>
                
                <div class="equipment-body">
                    <div class="equipment-photo">
                        {% if equipment.picturesData.generale is defined and equipment.picturesData.generale %}
                            <img src="data:image/jpeg;base64,{{ equipment.picturesData.generale }}" alt="Photo équipement">
                        {% else %}
                            <div style="width: 100%; height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #bdc3c7; border: 1px solid #bdc3c7; border-radius: 5px;">
                                Photo non disponible
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="equipment-details">
                        <table class="details-table">
                            <tr>
                                <th>Numéro</th>
                                <td>{{ equipment.numeroEquipement }}</td>
                            </tr>
                            <tr>
                                <th>Type</th>
                                <td>{{ equipment.libelleEquipement ?: 'Non renseigné' }}</td>
                            </tr>
                            <tr>
                                <th>Marque</th>
                                <td>{{ equipment.marque ?: 'nc' }}</td>
                            </tr>
                            <tr>
                                <th>Modèle</th>
                                <td>{{ equipment.modele ?: 'Non renseigné' }}</td>
                            </tr>
                            <tr>
                                <th>État</th>
                                <td>{{ statusMapping[equipment.etat] is defined ? statusMapping[equipment.etat] : equipment.etat }}</td>
                            </tr>
                            <tr>
                                <th>Mise en service</th>
                                <td>{{ equipment.miseEnService ?: 'nc' }}</td>
                            </tr>
                            <tr>
                                <th>Année</th>
                                <td>{{ equipment.dateEnregistrement ? equipment.dateEnregistrement|date('Y') : 'Année non présente sur équipement' }}</td>
                            </tr>
                            <tr>
                                <th>Repère site client</th>
                                <td>{{ equipment.repereSiteClient is defined ? equipment.repereSiteClient : 'Non repèré' }}</td>
                            </tr>
                            {% if equipment.anomalies is defined and equipment.anomalies is not null and equipment.anomalies|trim is not empty %}
                            <tr class="anomalies-row">
                                <th>Anomalies</th>
                                <td>{{ equipment.anomalies }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
            
            {# Fermer la page si on a 3 équipements ou si c'est le dernier #}
            {% if equipmentCount % 3 == 0 or loop.last %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
    
    {# PAGES ÉQUIPEMENTS SUPPLÉMENTAIRES #}
    {% if equipementsSupplementaires is defined and equipementsSupplementaires|length > 0 %}
        {% set suppCount = 0 %}
        {% for equipment in equipementsSupplementaires %}
            {% set suppCount = suppCount + 1 %}
            
            {# Nouveau page tous les 3 équipements #}
            {% if (suppCount - 1) % 3 == 0 %}
                {% if suppCount > 1 %}</div></div>{% endif %}
                <div class="equipment-page">
                    <div class="page-content">
            {% endif %}
            
            <div class="equipment-card">
                <div class="equipment-header">
                    <div class="equipment-status {{ statusColors[equipment.etat] ?: 'noir' }} status-icon"></div>
                    <div class="equipment-title">
                        <div class="equipment-number">Équipement {{ equipment.numeroEquipement }} - {{ equipment.libelleEquipement ?: 'Type non renseigné' }}</div>
                        <div class="equipment-type">{{ statusMapping[equipment.etat] ?: equipment.etat }}</div>
                    </div>
                </div>
                
                <div class="equipment-body">
                    <div class="equipment-photo">
                        {% if equipment.picturesData.generale is defined and equipment.picturesData.generale %}
                            <img src="data:image/jpeg;base64,{{ equipment.picturesData.generale }}" alt="Photo équipement">
                        {% else %}
                            <div style="width: 100%; height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #bdc3c7; border: 1px solid #bdc3c7; border-radius: 5px;">
                                Photo non disponible
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="equipment-details">
                        <table class="details-table">
                            <tr>
                                <th>Numéro</th>
                                <td>{{ equipment.numeroEquipement }}</td>
                            </tr>
                            <tr>
                                <th>Type</th>
                                <td>{{ equipment.libelleEquipement is defined ? equipment.libelleEquipement : 'Non renseigné' }}</td>
                            </tr>
                            <tr>
                                <th>Marque</th>
                                <td>{{ equipment.marque is defined ? equipment.marque : 'nc' }}</td>
                            </tr>
                            <tr>
                                <th>Modèle</th>
                                <td>{{ equipment.modele is defined ? equipment.modele : 'Non renseigné' }}</td>
                            </tr>
                            <tr>
                                <th>État</th>
                                <td>{{ statusMapping[equipment.etat] is defined ? statusMapping[equipment.etat] : equipment.etat }}</td>
                            </tr>
                            <tr>
                                <th>Mise en service</th>
                                <td>{{ equipment.miseEnService is defined ? equipment.miseEnService : 'nc' }}</td>
                            </tr>
                            <tr>
                                <th>Année</th>
                                <td>{{ equipment.dateEnregistrement ? equipment.dateEnregistrement|date('Y') : 'Année non présente sur équipement' }}</td>
                            </tr>
                            <tr>
                                <th>Repère site client</th>
                                <td>{{ equipment.repereSiteClient ?: 'Non repèré' }}</td>
                            </tr>
                            {% if equipment.anomalies is defined and equipment.anomalies is not null and equipment.anomalies|trim is not empty %}
                            <tr class="anomalies-row">
                                <th>Anomalies</th>
                                <td>{{ equipment.anomalies }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
            
            {# Fermer la page si on a 3 équipements ou si c'est le dernier #}
            {% if suppCount % 3 == 0 or loop.last %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
    
    {# FOOTER #}
    <div class="footer">
        Document généré automatiquement le {{ "now"|date_modify("+2 hours")|date('d/m/Y à H:i') }} 
        {% if equipmentsWithPictures is defined %}
            - {{ equipmentsWithPictures|length }} équipement{{ equipmentsWithPictures|length > 1 ? 's' : '' }} traité{{ equipmentsWithPictures|length > 1 ? 's' : '' }}
        {% endif %}
        {% if isFiltered is defined and isFiltered %}
            <br><em>Filtres appliqués lors de la génération</em>
        {% endif %}
    </div>
</body>
</html>